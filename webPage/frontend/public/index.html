<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estación Meteorológica</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <script>
        const jsonData = 'http://192.168.137.243:3000/data.json222';
        const savedDataArray = [];

        //download data from db
        async function downloadBackup() {
            const response = await fetch('/api/DataSave', {
                method: 'GET',
            });

            try {
                if (!response.ok) {
                    throw new Error(`Error al descargar datos: ${response.status}`);
                }

                const data = await response.json();
                const keys = Object.keys(data[0]);
                const csvContent = [
                    keys.join(','),
                    ...data.map(item => keys.map(key => item[key]).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });

                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(blob);
                downloadLink.download = 'backup.csv';

                downloadLink.click();
                URL.revokeObjectURL(downloadLink.href);

                console.log('Documento descargado');

            } catch (error) {
                console.error('Error al descargar: ', error);
            }
        }
        //download local data
        function downloadLocal() {
            const savedData = localStorage.getItem('savedData');
            const parsedData = JSON.parse(savedData);
            const stringData = parsedData.map(item =>
                `${item.timestamp},${item.id},${item.temperature},${item.co2Levele},${item.humidity},${item.uvLevel},${item.light}`
            ).join('\n');

            const keys = Object.keys(parsedData[0]);
            const csvContent = [
                keys.join(','),
                ...parsedData.map(item => keys.map(key => item[key]).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = 'data_local.csv';
            downloadLink.click();
            URL.revokeObjectURL(downloadLink.href);

            console.log('Documento descargado');
        }
        //find data from json
        async function fetchData() {
            try {
                const response = await fetch(jsonData);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const dataString = await response.text();
                const data = JSON.parse(dataString);
                updateUI(data);
                saveData(data);
                saveDataToLocalStorage();

            } catch (error) {
                console.error('Error al obtener datos:', error);
            }
        }
        //saves all data as arrays
	function saveData(data) {
	    const dataWithTimestamp = {
	        timestamp: new Date().toISOString(),
	        temperature: data.temperature,
	        humidity: data.humidity,
	        co2Level: data.co2Level,
	        light: data.light,
	        uvLevel: data.uvLevel
	    };
	    savedDataArray.push(dataWithTimestamp);
	    console.log('Datos guardados:', savedDataArray);
	}

        // transfers data to local storage
        function saveDataToLocalStorage() {
            if (savedDataArray.length === 0) {
                console.warn('No hay datos para guardar');
                return;
            }
            localStorage.setItem('savedData', JSON.stringify(savedDataArray));
            console.log('Datos guardados en localStorage');
            updateDisplay();
        }
        //shows updated data on display
        function updateDisplay() {
            const displayElement = document.getElementById('saved-content');
            const savedData = localStorage.getItem('savedData');
            displayElement.textContent = savedData ? JSON.stringify(JSON.parse(savedData), null, 2) : 'No hay datos disponibles aún.';
        }
        //upload data to db
        async function uploadDataToServer() {
            const savedData = localStorage.getItem('savedData');
            if (!savedData) {
                console.warn('No hay datos para enviar al servidor');
                return;
            }
            try {
                const parsedData = JSON.parse(savedData);
                const stringData = parsedData.map(item =>
                    `${item.timestamp},${item.id},${item.device},${item.temperatura},${item.co2},${item.humedad},${item.uvs},${item.luminica}`
                ).join('\n');

                const response = await fetch('/api/DataSave', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(parsedData)
                });

                if (!response.ok) {
                    throw new Error(`Error al enviar datos: ${response.status}`);
                }
                const result = await response.json();
                console.log('Datos subidos exitosamente:', result);
            } catch (error) {
                console.error('Error al subir datos:', error);
            }
        }
        //updates data showed in UI
	function updateUI(data) {
	    console.log('Actualizando UI con:', data);

	    // Seleccionamos los elementos HTML correspondientes
	    const temperatura = document.getElementById('temperatura1');
	    const humedad = document.getElementById('nivelHumedad1');
	    const nivelCO2 = document.getElementById('nivelCO21');
	    const luz = document.getElementById('intensidadLuminica1');
	    const rayosUV = document.getElementById('nivelRayosUV1');

	    // Verificamos que todos los elementos existan antes de actualizar
	    if (temperatura && humedad && nivelCO2 && luz && rayosUV) {
	        temperatura.textContent = `Temperatura: ${data.temperature}°C`;
	        humedad.textContent = `Humedad: ${data.humidity}%`;
	        nivelCO2.textContent = `Nivel de CO2: ${data.co2Level} ppm`;
	        luz.textContent = `Intensidad Luminosa: ${data.light} lux`;
	        rayosUV.textContent = `Nivel de Rayos UV: ${data.uvLevel}`;
	    } else {
	        console.error('Error: No se encontraron algunos elementos HTML');
	    }
	}
        

        async function initialize() {
            await fetchData();
        }

        //confirm before close session
        window.onbeforeunload = function (event) {
            const message = "Seguro que quieres salir?";
            event.returnValue = message;
            return message;
        };
        //clear old localstore files
        window.onload = function () {
            localStorage.clear();
            console.log('localStorage limpiado');
        };

        setInterval(fetchData, 10000);
        setInterval(uploadDataToServer, 3600000);

        initialize();

    </script>

    <div class="main-container">
        <h1 class="main-title">Estación Meteorológica</h1>
        <div class="arduino-container">
            <div class="left-container" id="app1">
                <div>
                    <h2 id="dispositivo1">ESP82</h2>
                    <p id="temperatura1">Temperatura: Cargando...</p>
                    <p id="nivelCO21">Nivel de CO2: Cargando...</p>
                    <p id="nivelHumedad1">Nivel de Humedad: Cargando...</p>
                    <p id="nivelRayosUV1">Nivel de Rayos UV: Cargando...</p>
                    <p id="intensidadLuminica1">Intensidad Luminica: Cargando...</p>
                </div>
            </div>        
            </div>
        </div>

        <div id="data-display" class="data-container">
            <h2>Datos Guardados</h2>
            <hr />
            <div>
                <code id="saved-content" class="json-data">No hay datos disponibles aún.</code>
                <div class="buttons-container">
                    <button onclick="downloadBackup()" title="Descarga los datos desde el backup">
                        <img src="downloadBackup.svg" alt="Download from DB">
                    </button>
                    <button onclick="downloadLocal()" title="Descarga los datos actuales">
                        <img src="downloadLocal.svg" alt="Download from LocalStorage">
                    </button>
                    <button onclick="uploadDataToServer()" title="Carga los datos a la DB">
                        <img src="uploadData.svg" alt="Upload to DB">
                    </button>
                </div>
            </div>

</body>

</html>
